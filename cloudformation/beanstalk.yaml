AWSTemplateFormatVersion: '2010-09-09'
Parameters:
  ApplicationInstanceType:
    Description: The compute and memory capacity of the application's EC2 instance type
    Type: String
    Default: t3.micro
    AllowedValues:
    - t3.micro
    - t3.xlarge
  ApplicationAutoScalingMinSize:
    Description: The minimum number of instances in the application auto scaling group
    Type: Number
    Default: 1
    MinValue: 1
  ApplicationAutoScalingMaxSize:
    Description: The maximum number of instances in the application auto scaling group
    Type: Number
    Default: 5
    MinValue: 1
  KeyName:
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instance
    Type: AWS::EC2::KeyPair::KeyName
    Default: ysy-key
    ConstraintDescription: Must be the name of an existing EC2 KeyPair.

Outputs:
  OriginApplicationUrl:
    Description: The URL to the load balancer for the Origin application
    Value: !GetAtt OriginEnvironment.EndpointURL

Resources:
  VueApplication:
    Type: AWS::ElasticBeanstalk::Application
    Properties:
      ApplicationName: YSY-FRONT
      Description: AWS Elastic Beanstalk G2-FRONT Application

  # Origin 
  OriginEnvironment:
    Type: AWS::ElasticBeanstalk::Environment
    Properties:
      ApplicationName: !Ref VueApplication
      Description: AWS ElasticBeanstalk G2-FRONT-ORIGIN Environment
      EnvironmentName: G2-FRONT-ORIGIN
      TemplateName: !Ref OriginConfigurationTemplate
  OriginConfigurationTemplate:
    Type: AWS::ElasticBeanstalk::ConfigurationTemplate
    DependsOn:
      - VueApplication
    Properties:
      ApplicationName: !Ref VueApplication
      Description: AWS ElasticBeanstalk G2-FRONT-ORIGIN Configuration Template
      PlatformArn: arn:aws:elasticbeanstalk:ap-northeast-2::platform/Node.js 12 running on 64bit Amazon Linux 2/5.3.1
      OptionSettings:
      #aws:autoscaling:asg
      - Namespace: aws:autoscaling:asg
        OptionName: MinSize
        Value: !Ref ApplicationAutoScalingMinSize
      - Namespace: aws:autoscaling:asg
        OptionName: MaxSize
        Value: !Ref ApplicationAutoScalingMaxSize
      #aws:autoscaling:launchconfiguration
      - Namespace: aws:autoscaling:launchconfiguration
        OptionName: IamInstanceProfile
        Value: aws-elasticbeanstalk-ec2-role
      - Namespace: aws:autoscaling:launchconfiguration
        OptionName: InstanceType
        Value: !Ref ApplicationInstanceType
      - Namespace: aws:autoscaling:launchconfiguration
        OptionName: EC2KeyName
        Value: !Ref KeyName
      #aws:autoscaling:launchconfiguration SecurityGroups default GroupName WEB(ID : sg-00ed0e2fedee98cc0)
      - Namespace: aws:autoscaling:launchconfiguration
        OptionName: SecurityGroups
        Value: WEB
      #aws:elasticbeanstalk:environment
      - Namespace: aws:elasticbeanstalk:environment
        OptionName: EnvironmentType
        Value: LoadBalanced
      - Namespace: aws:elasticbeanstalk:environment
        OptionName: ServiceRole
        Value: aws-elasticbeanstalk-service-role
      - Namespace: aws:elasticbeanstalk:environment
        OptionName: LoadBalancerType
        Value: application
      - Namespace: aws:elasticbeanstalk:environment:process:default
        OptionName: StickinessEnabled
        Value: 'true'
      #aws:elasticbeanstalk:healthreporting
      - Namespace: aws:elasticbeanstalk:healthreporting:system
        OptionName: SystemType
        Value: enhanced
      #aws:elbv2:loadbalancer SecurityGroups default GroupName WEB(ID : sg-00ed0e2fedee98cc0)
      - Namespace: aws:elbv2:loadbalancer
        OptionName: SecurityGroups
        Value: sg-00ed0e2fedee98cc0
      #aws:elbv2:listener:default ListenerEnabled set false mean : 80 port disable, .ebextensions alb.config create HTTPSRedirect
      - Namespace: aws:elbv2:listener:default
        OptionName: ListenerEnabled
        Value: false
      - Namespace: aws:elbv2:listener:443
        OptionName: ListenerEnabled
        Value: true
      - Namespace: aws:elbv2:listener:443
        OptionName: Protocol
        Value: HTTPS
      - Namespace: aws:elbv2:listener:443
        OptionName: SSLCertificateArns
        Value: arn:aws:acm:ap-northeast-2:871466012612:certificate/a8bd082e-f8db-4c9b-95db-c90077fd614a
      - Namespace: aws:elasticbeanstalk:application:environment
        OptionName: NODE_ENV
        Value: production